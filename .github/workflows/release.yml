name: Build and Release

on:
  push:
    branches:
      - main  # Run on pushes to main branch
  workflow_dispatch:  # Allow manual trigger

env:
  DOTNET_VERSION: '10.0.x'  # .NET 10.0
  CONFIGURATION: Release

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required for creating releases
      packages: write  # Required for publishing to GitHub Packages
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history to get correct commit count
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore
    
    # Get commit count for VersionSuffix
    - name: Get version
      id: get_version
      run: |
        COMMIT_COUNT=$(git rev-list --count HEAD)
        echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
        echo "Commit Count: $COMMIT_COUNT"
    
    - name: Build Ptr
      run: dotnet build src/Ptr/Ptr.csproj --configuration ${{ env.CONFIGURATION }} --no-restore /p:VersionSuffix=${{ steps.get_version.outputs.commit_count }}
    
    - name: Build modules
      run: |
        dotnet build src/Ptr.Modules.MapManager/Ptr.Modules.MapManager.csproj --configuration ${{ env.CONFIGURATION }} --no-restore /p:VersionSuffix=${{ steps.get_version.outputs.commit_count }}
        dotnet build src/Sharp.Modules.AdminManager/Sharp.Modules.AdminManager.csproj --configuration ${{ env.CONFIGURATION }} --no-restore /p:VersionSuffix=${{ steps.get_version.outputs.commit_count }}
        dotnet build src/Sharp.Modules.CommandManager/Sharp.Modules.CommandManager.csproj --configuration ${{ env.CONFIGURATION }} --no-restore /p:VersionSuffix=${{ steps.get_version.outputs.commit_count }}
    
    - name: Build Ptr.Shared
      run: |
        dotnet build src/Ptr.Shared/Ptr.Shared.csproj --configuration ${{ env.CONFIGURATION }} --no-restore /p:VersionSuffix=${{ steps.get_version.outputs.commit_count }}
        dotnet build src/Sharp.Modules.AdminManager.Shared/Sharp.Modules.AdminManager.Shared.csproj --configuration ${{ env.CONFIGURATION }} --no-restore /p:VersionSuffix=${{ steps.get_version.outputs.commit_count }}
        dotnet build src/Sharp.Modules.CommandManager.Shared/Sharp.Modules.CommandManager.Shared.csproj --configuration ${{ env.CONFIGURATION }} --no-restore /p:VersionSuffix=${{ steps.get_version.outputs.commit_count }}
    
    # Prepare release artifacts
    - name: Prepare Ptr module artifact
      run: |
        mkdir -p release/sharp/modules/Ptr
        cp src/Ptr/bin/${{ env.CONFIGURATION }}/net10.0/Ptr.dll release/sharp/modules/Ptr/
        # Copy any additional files if needed (e.g., dependencies)
        if [ -f src/Ptr/bin/${{ env.CONFIGURATION }}/net10.0/Ptr.pdb ]; then
          cp src/Ptr/bin/${{ env.CONFIGURATION }}/net10.0/Ptr.pdb release/sharp/modules/Ptr/
        fi

        if [ -f src/Ptr/bin/${{ env.CONFIGURATION }}/net10.0/Ptr.deps.json ]; then
          cp src/Ptr/bin/${{ env.CONFIGURATION }}/net10.0/Ptr.deps.json release/sharp/modules/Ptr/
        fi

        mkdir -p release/sharp/modules/Ptr.Modules.MapManager
        cp src/Ptr.Modules.MapManager/bin/${{ env.CONFIGURATION }}/net10.0/Ptr.Modules.MapManager.dll release/sharp/modules/Ptr.Modules.MapManager/
        if [ -f src/Ptr.Modules.MapManager/bin/${{ env.CONFIGURATION }}/net10.0/Ptr.Modules.MapManager.pdb ]; then
          cp src/Ptr.Modules.MapManager/bin/${{ env.CONFIGURATION }}/net10.0/Ptr.Modules.MapManager.pdb release/sharp/modules/Ptr.Modules.MapManager/
        fi

        if [ -f src/Ptr.Modules.MapManager/bin/${{ env.CONFIGURATION }}/net10.0/Ptr.Modules.MapManager.deps.json ]; then
          cp src/Ptr.Modules.MapManager/bin/${{ env.CONFIGURATION }}/net10.0/Ptr.Modules.MapManager.deps.json release/sharp/modules/Ptr.Modules.MapManager/
        fi

        mkdir -p release/sharp/modules/Sharp.Modules.AdminManager
        cp src/Sharp.Modules.AdminManager/bin/${{ env.CONFIGURATION }}/net10.0/Sharp.Modules.AdminManager.dll release/sharp/modules/Sharp.Modules.AdminManager/
        if [ -f src/Sharp.Modules.AdminManager/bin/${{ env.CONFIGURATION }}/net10.0/Sharp.Modules.AdminManager.pdb ]; then
          cp src/Sharp.Modules.AdminManager/bin/${{ env.CONFIGURATION }}/net10.0/Sharp.Modules.AdminManager.pdb release/sharp/modules/Sharp.Modules.AdminManager/
        fi

        if [ -f src/Sharp.Modules.AdminManager/bin/${{ env.CONFIGURATION }}/net10.0/Sharp.Modules.AdminManager.deps.json ]; then
          cp src/Sharp.Modules.AdminManager/bin/${{ env.CONFIGURATION }}/net10.0/Sharp.Modules.AdminManager.deps.json release/sharp/modules/Sharp.Modules.AdminManager/
        fi

        mkdir -p release/sharp/modules/Sharp.Modules.CommandManager
        cp src/Sharp.Modules.CommandManager/bin/${{ env.CONFIGURATION }}/net10.0/Sharp.Modules.CommandManager.dll release/sharp/modules/Sharp.Modules.CommandManager/
        if [ -f src/Sharp.Modules.CommandManager/bin/${{ env.CONFIGURATION }}/net10.0/Sharp.Modules.CommandManager.pdb ]; then
          cp src/Sharp.Modules.CommandManager/bin/${{ env.CONFIGURATION }}/net10.0/Sharp.Modules.CommandManager.pdb release/sharp/modules/Sharp.Modules.CommandManager/
        fi

        if [ -f src/Sharp.Modules.CommandManager/bin/${{ env.CONFIGURATION }}/net10.0/Sharp.Modules.CommandManager.deps.json ]; then
          cp src/Sharp.Modules.CommandManager/bin/${{ env.CONFIGURATION }}/net10.0/Sharp.Modules.CommandManager.deps.json release/sharp/modules/Sharp.Modules.CommandManager/
        fi
    
    - name: Prepare Ptr.Shared artifact
      run: |
        mkdir -p release/sharp/shared/Ptr.Shared
        cp src/Ptr.Shared/bin/${{ env.CONFIGURATION }}/net10.0/Ptr.Shared.dll release/sharp/shared/Ptr.Shared/
        # Copy any additional files if needed
        if [ -f src/Ptr.Shared/bin/${{ env.CONFIGURATION }}/net10.0/Ptr.Shared.pdb ]; then
          cp src/Ptr.Shared/bin/${{ env.CONFIGURATION }}/net10.0/Ptr.Shared.pdb release/sharp/shared/Ptr.Shared/
        fi

        mkdir -p release/sharp/shared/Ptr.Modules.MapManager.Shared
        cp src/Ptr.Modules.MapManager.Shared/bin/${{ env.CONFIGURATION }}/net10.0/Ptr.Modules.MapManager.Shared.dll release/sharp/shared/Ptr.Modules.MapManager.Shared/
        if [ -f src/Ptr.Modules.MapManager.Shared/bin/${{ env.CONFIGURATION }}/net10.0/Ptr.Modules.MapManager.Shared.pdb ]; then
          cp src/Ptr.Modules.MapManager.Shared/bin/${{ env.CONFIGURATION }}/net10.0/Ptr.Modules.MapManager.Shared.pdb release/sharp/shared/Ptr.Modules.MapManager.Shared/
        fi

        mkdir -p release/sharp/shared/Sharp.Modules.AdminManager.Shared
        cp src/Sharp.Modules.AdminManager.Shared/bin/${{ env.CONFIGURATION }}/net10.0/Sharp.Modules.AdminManager.Shared.dll release/sharp/shared/Sharp.Modules.AdminManager.Shared/
        if [ -f src/Sharp.Modules.AdminManager.Shared/bin/${{ env.CONFIGURATION }}/net10.0/Sharp.Modules.AdminManager.Shared.pdb ]; then
          cp src/Sharp.Modules.AdminManager.Shared/bin/${{ env.CONFIGURATION }}/net10.0/Sharp.Modules.AdminManager.Shared.pdb release/sharp/shared/Sharp.Modules.AdminManager.Shared/
        fi

        mkdir -p release/sharp/shared/Sharp.Modules.CommandManager.Shared
        cp src/Sharp.Modules.CommandManager.Shared/bin/${{ env.CONFIGURATION }}/net10.0/Sharp.Modules.CommandManager.Shared.dll release/sharp/shared/Sharp.Modules.CommandManager.Shared/
        if [ -f src/Sharp.Modules.CommandManager.Shared/bin/${{ env.CONFIGURATION }}/net10.0/Sharp.Modules.CommandManager.Shared.pdb ]; then
          cp src/Sharp.Modules.CommandManager.Shared/bin/${{ env.CONFIGURATION }}/net10.0/Sharp.Modules.CommandManager.Shared.pdb release/sharp/shared/Sharp.Modules.CommandManager.Shared/
        fi

    
    # Copy assets (gamedata, configs, etc.)
    - name: Copy assets
      run: |
        if [ -d .asset/game ]; then
          cp -r .asset/game/* release/
          echo "Assets copied to release/"
        else
          echo "No assets found, skipping..."
        fi
    
    # Package Ptr.Shared for NuGet
    - name: Pack Ptr.Shared for NuGet
      run: dotnet pack src/Ptr.Shared/Ptr.Shared.csproj --configuration ${{ env.CONFIGURATION }} --no-build --output nupkgs /p:VersionSuffix=${{ steps.get_version.outputs.commit_count }}
    
    # Get the actual version that was built
    - name: Get built version
      id: built_version
      run: |
        VERSION_PREFIX=$(grep -oP '<VersionPrefix>\K[^<]+' src/Directory.Build.props)
        VERSION="${VERSION_PREFIX}.${{ steps.get_version.outputs.commit_count }}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Built Version: $VERSION"
    
    # Create release archives
    - name: Create release archives
      run: |
        cd release
        tar -czf ../ptr-release.tar.gz sharp/
        cd ..
        zip -r ptr-release.zip release/sharp/
    
    # Upload artifacts to workflow
    - name: Upload Ptr module artifact
      uses: actions/upload-artifact@v4
      with:
        name: ptr-module
        path: release/sharp/modules/Ptr/
    
    - name: Upload Ptr.Shared artifact
      uses: actions/upload-artifact@v4
      with:
        name: ptr-shared
        path: release/sharp/shared/Ptr.Shared/
    
    - name: Upload NuGet package
      uses: actions/upload-artifact@v4
      with:
        name: nuget-package
        path: nupkgs/*.nupkg
    
    # Publish to NuGet (on main branch or tags)
    - name: Publish to NuGet
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
      run: dotnet nuget push nupkgs/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
      continue-on-error: true  # Don't fail if package already exists
    
    # Create GitHub Release
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('v{0}', steps.built_version.outputs.version) }}
        name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('v{0}', steps.built_version.outputs.version) }}
        files: |
          ptr-release.tar.gz
          ptr-release.zip
        body: |
          ## Release v${{ steps.built_version.outputs.version }}
          
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
